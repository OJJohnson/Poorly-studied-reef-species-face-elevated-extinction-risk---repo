---
title: "Poorly studied reef species face elevated extinction risk"
author: "Olivia J. Johnson, Freddie J. Heather & Camille Mellin"
date: "`r Sys.Date()`"
output: 
  rmdformats::downcute:
  # bookdown::html_document2:
    code_folding: show
---

# About this script

The following document provides the R code for the analysis for the paper: Johnson *et al.* (in review.) Poorly studied reef species face elevated extinction risk.

**\*Corresponding author:**
[olivia.johsnon\@utas.edu.au](mailto:olivia.johsnon@utas.edu.au){.email}

+------------------------+-------------------------------------------------------------------------------------------------------+
| **R-version**          | 4.3.1 (2023-06-16 ucrt) -- "Beagle Scouts"                                                            |
+------------------------+-------------------------------------------------------------------------------------------------------+
| **platform**           | x86_64-w64-mingw32                                                                                    |
+------------------------+-------------------------------------------------------------------------------------------------------+
| **Article DOI**        |                                                                                                       |
+------------------------+-------------------------------------------------------------------------------------------------------+
| **Article link**       |                                                                                                       |
+------------------------+-------------------------------------------------------------------------------------------------------+
| **Article citation**   | Johnson *et al.* (in review.) Poorly studied reef species face elevated extinction risk warming. |
+------------------------+-------------------------------------------------------------------------------------------------------+
| **Time series**        | 2008-2022                                                                                             |
+------------------------+-------------------------------------------------------------------------------------------------------+
| **Geographical scale** | Continental Australia                                                                                 |
+------------------------+-------------------------------------------------------------------------------------------------------+
| **Code author contact**| olivia.johnson@utas.edu.au                                                                            |
+------------------------+-------------------------------------------------------------------------------------------------------+

# Set-up

```{r knitr-options}
#| include = FALSE

library(knitr)
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)

# save csv files for each step?
save_csv <- TRUE

```

# Loading packages
Load in all required packages for this analysis
```{r packages}

library(knitr)
library(tidyverse)
library(janitor)
library(lubridate)
library(lme4)
library(lmerTest)
library(zoo, include.only = "na.approx")

# "not in" function
`%!in%` <- Negate(`%in%`)
```

# Read in raw data
The raw data is in a wide format and is publicly available to download from https://portal.aodn.org.au/ 
```{r include=FALSE}
# Raw in-situ (ATRC) Algae data
algae_raw <- read_csv("ep_m3.csv", 
                      show_col_types = FALSE)

# RLS/ATRC Method 1
fish_raw <- 
  read_csv("ep_m1_AUS.csv", 
           show_col_types = FALSE) %>% 
  mutate(survey_date = as.Date(survey_date, format = "%d/%m/%Y"))

# RLS/ATRC Method 2 (fish only)
cryptic_fish_raw <- 
  read_csv("ep_m2_cryptic_fish_AUS.csv", 
           show_col_types = FALSE) %>% 
  mutate(survey_date = as.Date(survey_date, format = "%Y-%m-%d"))

# RLS/ATRC Method 2 (invertebrates only)
inverts_raw <- read_csv("ep_m2_inverts_AUS.csv", 
                        show_col_types = FALSE)

coral_raw <- read_csv("PQ_FullRes_infilled.csv", 
                      show_col_types = FALSE)

```

# Covariate data
```{r include=FALSE}

# species-level information
species_tbl <- 
  read_csv(file = "species_info.csv", 
           show_col_types = FALSE, 
           skip_empty_rows = TRUE) 

# temperature time-series (post-2008) data for each site
temperature_raw <- 
  read_csv(file =  "temperature_timeseries.csv",
           show_col_types = FALSE, 
           skip_empty_rows = TRUE)

# endemism dataframe
endemism <- 
  read_csv(file =  "endemism.csv",
           show_col_types = FALSE, 
           skip_empty_rows = TRUE)

```

# Data Cleaning
## Algae
Here, I will use the 30 years of ATRC data which has been entered as
NRNM "M3" data and will filter this data to extract just the "algal"
phylum only (i.e. remove substrate type and other sessile invertebrate
species). This also requires amalgamating data for species that have had
taxonomic name changes over time, and importantly, species that were not
morphologically distinct enough to be consistently recognised by all
in-situ data records were additionally removed from the analysis.

Temperate algae data is scored in a point-count method via a quadrat
with 50 points - I will convert this data so that it is on a percentage
cover (multiply totals by 2, to convert to % cover).

### Filtering species
```{r include=FALSE}
#Algae filtering
sum(is.na(algae_raw$total))
# There are 28 examples where there is a "0" value for the raw algae data

# Total number of species being considered (n = 801):
num_species <- 
  algae_raw %>%
  distinct(species_name) %>%
  nrow()

# filter (and keep) out phylum containing algae only, taxonomic name changes, and species that were not morphologically distinctive enough to be consistently recognised by all in-situ data records (verified list by G. Edgar)
algae_rmspp <- 
  algae_raw %>% 
  filter(phylum %in% c("algae", 
                       "Heterokontophyta",
                       "Rhodophyta",
                       "Chlorophyta",
                       "Tracheophyta",
                       "Ochrophyta"
  )) %>% 
  filter(str_detect(species_name, "[A-Z]{1}[a-z]+\\s{1}[a-z]+$")) %>% 
  filter(!str_detect(species_name, "Unidentified")) %>% 
  filter(species_name %!in% c("Ritterella pedunculata",
                              "Herdmania grandis",
                              "Anthothoe albocincta",
                              "Ostrea angasi",
                              "Phlyctenanthus australis",
                              "Pyura australis",
                              "Mytilus galloprovincialis",
                              "Bare rock",
                              "Turf/sand/sediment matrix",
                              "Zonaria turneriana/angustata",
                              "Cladophora prolifera",
                              "Sargassum podacanthum",
                              "Codium galeatum",
                              "Bornetia binderiana",
                              "Holotrichia comosa",
                              "Sargassum distichum",
                              "Dictyota naevosa",
                              "Mesophyllum incisum",
                              "Hymenena curdieana",
                              "Acrosorium ciliolatum",
                              "Platoma cyclocolpum",
                              "Gracilaria secundata",
                              "Dictyomenia sonderi",
                              "Peltasta australis",
                              "Homoeostrichus sinclairii",
                              "Dictyota fastigiata",
                              "Grateloupia filicina",
                              "Phacelocarpus alatus",
                              "Callophyllis lambertii",
                              "Dictyota paniculata",
                              "Acrotylus australis",
                              "Jania pulchella",
                              "Delisea hypneoides",
                              "Gelinaria ulvoidea",
                              "Carpopeltis phyllophora",
                              "Cephalocystis furcellata",
                              "Wrangelia nobilis",
                              "Ptilota hannafordii",
                              "Rhodymenia verrucosa",
                              "Laurencia filiformis",
                              "Scinaia tsinglanensis",
                              "Rhodymenia leptophylla",
                              "Distromium multifidum",
                              "Codium fragile",
                              "Pterocladiella capillacea",
                              "Protokuetzingia australasica",
                              "Hypnea pannosa", 
                              "Grateloupia turuturu", 
                              "Taonia australasica", 
                              "Rhodophyllis multipartita", 
                              "Phymatolithon masonianum", 
                              "Coelarthrum opuntia", 
                              "Delisea elegans",
                              "Hymenena affinis", 
                              "Griffithsia monilis", 
                              "Rhodymenia obtusa", 
                              "Halymenia plana",
                              "Tsengia feredayae", 
                              "Champia stipitata", 
                              "Ptilonia australasica",
                              "Jania sagittata",
                              "Kallymenia tasmanica",
                              "Pseudobryopsis hainanensis", 
                              "Mychodea carnosa", 
                              "Craspedocarpus venosus", 
                              "Craspedocarpus tenuifolius", 
                              "Rhodymenia wilsonis",
                              "Nizymenia australis", 
                              "Codium duthieae", 
                              "Nizymenia furcata", 
                              "Dictyota gunniana", 
                              "Plocamium costatum", 
                              "Chondria incrassata", 
                              "Gracilaria preissiana", 
                              "Exallosorus olsenii",
                              "Curdiea angustata",
                              "Chlanidophora microphylla", 
                              "Amansia rhodantha", 
                              "Gelidium asperum", 
                              "Cladostephus spongiosus",
                              "Rhodopeltis australis", 
                              "Phacelocarpus sessilis",
                              "Rhodopeltis borealis",
                              "Laurencia majuscula",
                              "Sargassum paradoxum",
                              "Sporochnus radiciformis",
                              "Coelarthrum cliftonii", 
                              "Jania rosea",
                              "Erythroclonium sonderi", 
                              "Nizymenia conferta", 
                              "Gelidium australe", 
                              "Tylotus obtusatus", 
                              "Codium harveyi", 
                              "Sonderophycus coriaceus",
                              "Myriodesma integrifolium", 
                              "Acrosorium minus", 
                              "Champia zostericola",
                              "Callophycus serratus",
                              "Acanthophora dendroides",
                              "Rhodymenia prolificans", 
                              "Hymenocladia usnea", 
                              "Zonaria diesingiana", 
                              "Halopeltis australis", 
                              "Stypopodium flabelliforme", 
                              "Polysiphonia blandii",
                              "Zonaria turneriana", 
                              "Dictyota nigricans", 
                              "Jania micrarthrodia",
                              "Plocamium cirrhosum", 
                              "Rhodymenia sonderi", 
                              "Mychodea aciculare", 
                              "Phacelocarpus apodus", 
                              "Peyssonnelia novaehollandiae",
                              "Laurencia clavata", 
                              "Myriogramme gunniana",
                              "Melanthalia abscissa", 
                              "Polyopes constrictus",
                              "Distromium flabellatum",
                              "Carpopeltis elata",
                              "Callophycus laxus",
                              "Euptilocladia spongiosa",
                              "Sargassum spinuligerum", 
                              "Cladosiphon filum", 
                              "Dasya extensa", 
                              "Corallina officinalis", 
                              "Encyothalia cliftonii", 
                              "Dicranema revolutum", 
                              "Dictyopteris plagiogramma", 
                              "Nitospinosa tasmanica", 
                              "Echinothamnion mallardiae",
                              "Sargassum oligocystum", 
                              "Sargassum lacerifolium", 
                              "Erythroclonium muelleri", 
                              "Amphiroa gracilis", 
                              "Myriodesma tuberosum", 
                              "Sargassum linearifolium", 
                              "Heterosiphonia muelleri", 
                              "Sargassum ligulatum",
                              "Zostera nigricaulis")) %>% 
  mutate(survey_year = year(survey_date)) %>% 
  # ensure species that have had a taxonomic name change over time have the data points merged together (these species highlighted by GE)
  mutate(species_name = case_when(
    species_name == "Caulerpa annulata" ~ "Caulerpa hodgkinsoniae",
    species_name == "Sargassum decipiens" ~ "Phyllotricha varians",
    species_name == "Sargassum varians" ~ "Phyllotricha decipiens",
    species_name == "Sargassum verruculosum" ~ "Phyllotricha verruculosa", 
    species_name == "Sargassum heteromorphum" ~ "Sargassopsis heteromorphum", 
    TRUE ~ species_name
  )) %>% 
  select(
    survey_id,
    site_code,
    location,
    area,
    ecoregion,
    survey_year,
    phylum,
    species_name,
    quadrat,
    habitat_groups,
    total,
    taxon,
    latitude,
    longitude) %>% 
  as_tibble()  


algae_lat_lons <-
  algae_raw %>% 
  drop_na(latitude, longitude) %>% 
  summarise(latitude = mean(latitude), 
            longitude = mean(longitude), 
            .by = site_code)

```

### Cleaning counts
```{r include=FALSE}
algae_clean <- 
  algae_rmspp %>% 
  filter(total <= 50) %>% # keep single observations less than or equal to 50
  filter(survey_year >= 2008) %>% #NEW - filter out data from 2008 onwards
  add_count(survey_id, quadrat, wt = total) %>% 
  mutate(cover = total*2) %>% 
  summarise(cover = mean(cover), #mean quadrat summary for survey
            .by = c(species_name, 
                    site_code,
                    location,
                    ecoregion,
                    survey_year)) 

```

### Dealing with NAs
As per methods in Edgar et al. 2023, We want NA values to be changed to zeros 
when all of the following conditions are met:

1.  The site was surveyed that year.
2.  The species was observed at least once at that site in any other
year.
3.  The species was recorded at that site at that year.

To do this we need to make a list of all the site\*year combinations,
all site\*species combinations, and all site\*year\*taxon combinations
**that have at least one observation**. If the row in question has a
site\*year combination that is found in the overall site\*year
combination list, then we know that site was surveyed in that year and
therefore meets the first condition. We repeat for the first three
conditions, if all three are met and the count is NA, we replace with a
zero value.

```{r include=FALSE}
#Algae NA convert
# site*year combinations
algae_site_byyear <-
  algae_clean |> 
  filter(!(is.na(cover)|cover == 0)) |> # not recorded
  select(site_code, survey_year) |> 
  distinct() |> 
  mutate(site_code_yr = paste(site_code, survey_year, sep = "_"))

# site*year*species combinations
algae_site_byspp <-
  algae_clean |> 
  filter(!(is.na(cover)|cover == 0)) |> # not recorded
  select(site_code, species_name) |> 
  distinct() |> 
  mutate(site_code_spp = paste(site_code, species_name, sep = "_"))

algae_site_byspp_nested <- 
  algae_site_byspp %>% 
  select(site_code, species_name) %>% 
  nest(.by = site_code)

# Chaetomorpha billardierii is in algae_site_byyear but not algae_clean

algae_data_addingzeros <- 
  algae_site_byyear %>% 
  select(site_code, survey_year) %>% 
  left_join(algae_site_byspp_nested, 
            by = join_by(site_code)) %>% 
  unnest(cols = c(data)) %>% 
  left_join(algae_clean %>% 
              select(site_code, 
                     survey_year, 
                     species_name, 
                     cover),
            by = join_by(site_code, survey_year, species_name)) %>% 
  left_join(algae_lat_lons, by = join_by(site_code)) %>% 
  mutate(cover = replace_na(cover, 0)) %>%
  mutate(sqrt_cover = sqrt(cover))

#| include = FALSE
algae_data_addingzeros |> filter(is.na(sqrt_cover)) |> nrow()


algae_site_species_keep <- 
  algae_data_addingzeros %>% 
  filter(sqrt_cover > 0) %>%
  add_count(site_code, species_name, name = "n_site_species") %>% 
  filter(n_site_species > 3) %>% 
  mutate(site_spp = paste(site_code, species_name, sep = "_")) %>% 
  pull(site_spp) %>% 
  unique()

# this will be used as the main dataframe
algae_data <- 
  algae_data_addingzeros |> 
  mutate(latitude  = round(latitude),
         longitude = round(longitude)) |> 
  mutate(transect_id = paste(site_code, survey_year, sep = "_")) %>% 
  mutate(n_sites_byspp = n(), .by = c(site_code, species_name)) %>% 
  mutate(n_obs_byspp = n(), .by = c(species_name)) %>% 
  filter(n_obs_byspp > n_sites_byspp) %>% 
  # site*species combinations with three or more obs
  add_count(site_code, species_name, name = "n_site_species") %>% 
  filter(n_site_species > 3) %>%
  filter(paste(site_code, species_name, sep = "_") %in% algae_site_species_keep) %>%
  # species must be see in more than one site
  filter(n_distinct(site_code) > 1, 
         .by = species_name) 


# check to see if filtering has worked
algae_clean %>% 
  count(site_code, species_name, 
        name = "n_obs") %>% 
  arrange(n_obs)

# check to see if filtering has worked
algae_clean %>% 
  select(site_code, species_name) %>% 
  distinct() %>% 
  count(species_name, name = "n_sites") %>% 
  arrange(n_sites)

```

## Fish
Here, I will load in all fish data, this includes M1 data and all
"cryptic fish" scored in M2 that has been separated into their own data
set (both ATRC and RLS). To ensure fish counts Australia wide, and so
there is not a concentration on the temperate region from the ATRC
surveys from 1992, I will filter all the data so it is only from the
inception of RLS, therefore from 2008 on wards.

As M1 fish and M2 fish are scored on a different scale/different search
efforts, I will ensure all counts for fish are (reduced for M1) measured
on a 50m2 scale. Additionally, ANY and ALL fish sighted on M1 surveys
are recorded, so to ensure cryptic fish counts made on a M1 survey are
counted towards the trend of the species, M1 and cryptic fish datasets
will be combined, scaled to 50m2 (also to take into account the two
blocks per survey), filtered from 2008 on wards, in a site\*year
combination (due to the case there may be multiple surveys at one site
during a year). To prevent inflation of certain species, the fish data
will be logged before any modelling occurs.

```{r include=FALSE}
# combine raw fish (M1) and cryptic fish (M2) datasets
fish_combined <- 
  fish_raw %>% 
  bind_rows(cryptic_fish_raw) %>% 
  mutate(site_yr = paste(site_code, year(survey_date), sep = "_"), 
         survey_year = year(survey_date))

```

### Cleaning counts
```{r include=FALSE}
# Only method 1 and post-2008
fish_corrected_data <- 
  fish_combined %>%
  mutate(total_per50m2 = case_when(method == 1 ~ total/5, 
                                   TRUE ~ total)) %>% 
  filter(survey_year >= 2008) 


# Sum the total for each species within each unique sitexyear and block
fish_count_byblock <- 
  fish_corrected_data %>%
  mutate(site_yr = paste(site_code, year(survey_date), sep = "_")) %>%
  summarise(total_per50m2 = sum(total_per50m2), 
            .by = c(block, 
                    survey_id,
                    site_yr, 
                    site_code, 
                    survey_year, 
                    species_name))

# Calculate the average of the total per site x date combination
fish_average_data <- 
  fish_count_byblock %>%
  summarise(total_per50m2 = mean(total_per50m2), 
            .by = c(site_yr, 
                    survey_id, 
                    site_code, 
                    survey_year,
                    species_name)) 

# remove incorrectly named species
fish_filtered <- 
  fish_average_data %>% 
  filter(str_detect(species_name, "[A-Z]{1}[a-z]+\\s{1}[a-z]+$")) %>% 
  filter(!str_detect(species_name, "Unidentified")) %>% 
  filter(!str_detect(species_name, "\\[|\\]")) 

# create a dataframe "survey_list" which contains the other data which may be 
# some lat, lon are very slightly different (e.g. survey_id == 923400036)
fish_survey_list <- 
  fish_combined %>% 
  select(site_yr, 
         site_code, 
         survey_id,
         survey_year, 
         latitude, 
         longitude) %>% 
  distinct() %>% 
  summarise(latitude = mean(latitude),
            longitude = mean(longitude),
            .by = c(site_yr, 
         site_code, 
         survey_id,
         survey_year))

fish_clean <-
  fish_filtered %>% 
  mutate(n_sites_byspp = n(), .by = c(site_code, species_name)) %>% 
  mutate(n_obs_byspp = n(), .by = c(species_name)) %>% 
  filter(n_obs_byspp > n_sites_byspp) %>% 
  left_join(fish_survey_list, 
            by = join_by(site_yr, survey_id,
                     site_code, 
                     survey_year)) %>% 
  summarise(total_per50m2 = mean(total_per50m2),
            .by = c(site_yr, species_name,
                     site_code, 
                     survey_year))

#Four lined cardinal name change from Apogon doederleini to Ostorhinchus doederleini - amend to current WoRMS listing:
fish_clean$species_name[fish_clean$species_name == "Apogon doederleini"] <- "Ostorhinchus doederleini" 
```

### Dealing with NAs
```{r include=FALSE}
#Fish NA convert
# A list of all the site*year combinations
fish_site_byyear <-
  fish_clean |> 
  filter(!(is.na(total_per50m2)|total_per50m2 == 0)) |> # not recorded
  select(site_yr,
                     site_code, 
                     survey_year) |> 
  distinct() 

# A list of all the site*year*species combinations
fish_site_byspp <-
  fish_corrected_data |> 
  filter(!(is.na(total_per50m2)|total_per50m2 == 0)) |> # not recorded
  select(site_yr, species_name,
                     site_code, 
                     survey_year) |> 
  distinct() 

fish_site_byspp_nested <- 
  fish_site_byspp %>% 
  select(site_yr, species_name,
                     site_code, 
                     survey_year) %>% 
  nest(.by = c(site_yr, 
                     site_code, 
                     survey_year))

fish_data_addingzeros <- 
  fish_site_byyear %>% 
  select(site_yr) %>% 
  left_join(fish_site_byspp_nested, 
            by = join_by(site_yr)) %>% 
  unnest(cols = c(data)) %>% 
  left_join(fish_clean %>% 
              select(species_name,
                     site_yr,
                     site_code, 
                     survey_year,
                     total_per50m2)) %>% 
  mutate(total_per50m2 = replace_na(total_per50m2, 0)) %>%
  mutate(total_per50m2 = as.numeric(total_per50m2)) 


fish_data_addingzeros |> filter(is.na(total_per50m2)) |> nrow()

################ MinN attempt ##############
# Calculate the minimum density per species per site
min_density <- fish_data_addingzeros %>%
  filter(total_per50m2 > 0) %>%
  group_by(site_code, species_name) %>%
  summarise(minN = min(total_per50m2)) %>%
  ungroup()

# Join the min_density table to the main species count table
fish_data_with_minN <- fish_data_addingzeros %>%
  left_join(min_density, by = c("site_code", "species_name"))

# Continue with the rest of your existing code
fish_site_species_keep <- 
  fish_data_with_minN %>% 
  filter(total_per50m2 > 0) %>% 
  add_count(site_code, species_name, name = "n_site_species") %>% 
  filter(n_site_species > 3) %>% 
  mutate(site_spp = paste(site_code, species_name, sep = "_")) %>% 
  pull(site_spp) %>% 
  unique()

fish_data <- 
  fish_data_with_minN %>% 
  left_join(fish_survey_list %>% 
              summarise(latitude = mean(latitude), 
                        longitude = mean(longitude), 
                        .by = site_yr), 
            by = join_by(site_yr)) %>% 
  mutate(latitude = round(latitude),
         longitude = round(longitude), 
         log_count = log10(total_per50m2 + minN/2)) %>%  # Use minN for log transformation
  mutate(year = substr(site_yr, nchar(site_yr) - 3, nchar(site_yr)) %>% 
           as.numeric(),
         site_code = substr(site_yr, 1, nchar(site_yr) - 5)) %>% 
   add_count(site_code, species_name, name = "n_site_species") %>% 
  filter(n_site_species > 3) %>% 
    filter(paste(site_code, species_name, sep = "_") %in% fish_site_species_keep) %>%
  # species must be seen in more than one site
  filter(n_distinct(site_code) > 1, 
         .by = species_name)

#Total number of species being considered after filtering: 1669
num_species_fish <- 
  fish_data %>%
  distinct(species_name) %>%
  nrow()
print(num_species_fish)


#Check to see if filtering has worked
table(fish_data$site_code) %>% 
  sort() %>% 
  head()
```

## Invertebrates
Here, I will load in all invertebrate data, both ATRC and RLS combined
datasets. Invertebrates are surveyed on the 50m2 scale. The same as
above with fish, to ensure there is not a concentration on the temperate
region from the ATRC surveys from 1992, I will filter all M2
invertebrate data so it is only from the inception of RLS, therefore
from 2008 onwards.

As a check to make sure there are no cryptic fish that have made there
way into this dataset, I will do a filter to ensure there are no
observations with the phylum "Chordata" in the dataset, and the data is
representative of observations to the species level. To prevent
inflation of certain species, the invertebrate data will be logged
before any modelling occurs.

```{r include=FALSE}
sum(is.na(inverts_raw$total))

# Total number of M2 inverts being considered: 1373
invert_num_species <- 
  inverts_raw %>%
  distinct(species_name) %>%
  nrow()
print(invert_num_species)

#first let's check what "Phylum" groups are contained in the "invertebrate raw" dataframe
inverts_raw %>% 
  filter(phylum == "Chordata") %>% 
  nrow()
# data should have ZERO Chordates - 2252 observations found, filter out below

#filter (and keep) inverts columns
inverts_clean <- 
  inverts_raw %>% 
  filter(str_detect(species_name, "[A-Z]{1}[a-z]+\\s{1}[a-z]+$")) %>% 
  filter(!str_detect(species_name, "Unidentified")) %>% 
  mutate(survey_year = year(survey_date)) %>% 
  filter(!str_detect(species_name, "\\[|\\]")) %>% 
  filter(phylum %!in% c("Chordata")) %>%
  filter(species_name %!in% c("Asthenosoma varium",
                              "Equichlamys bifrons",
                              "Oxycomanthus bennetti",
                              "Cronia avellana",
                              "Neothyonidium magnum",
                              "Mimachlamys asperrima")) %>%
  dplyr::select(
    survey_id,
    site_code,
    location,
    area,
    ecoregion,
    survey_year,
    phylum,
    species_name,
    size_class,
    total,
    taxon,
    latitude,
    longitude,
    method,
    block) %>% 
  as_tibble() 

#Seastar species with two spelling versions of species name - amend to current WoRMS listing:
inverts_clean$species_name[inverts_clean$species_name == "Pentagonaster dubeni"] <- "Pentagonaster duebeni" 

#Update to P. chabrus name according to WoRMS
inverts_clean <- inverts_clean %>%
  mutate(species_name = ifelse(species_name == "Plagusia chabrus", "Guinusia chabrus", species_name))

inverts_clean <- inverts_clean %>%
  mutate(taxon = ifelse(taxon == "Plagusia chabrus", "Guinusia chabrus", taxon))

#Comanthus to Cenolia
inverts_clean <- inverts_clean %>%
  mutate(species_name = ifelse(species_name == "Comanthus tasmaniae", "Cenolia tasmaniae", species_name))

inverts_clean <- inverts_clean %>%
  mutate(taxon = ifelse(taxon == "Comanthus tasmaniae", "Cenolia tasmaniae", taxon))

#Pterynotus to Pterochelus at genus level
inverts_clean <- inverts_clean %>%
  mutate(species_name = ifelse(species_name == "Pterynotus triformis", "Pterochelus triformis", species_name))

inverts_clean <- inverts_clean %>%
  mutate(taxon = ifelse(taxon == "Pterynotus triformis", "Pterochelus triformis", taxon))


# #Inconsistent records of Goniocidaris tubaria - make all records "Goniocidaris impressa"
# inverts_clean$species_name[inverts_clean$species_name == "Goniocidaris tubaria"] <- "Goniocidaris impressa" 

#Total number of M2 species being considered after filtering: 1050
inverts_num_species_2 <- 
  inverts_clean %>%
  distinct(species_name) %>%
  nrow()
print(inverts_num_species_2)

#view list of M2 species
inverts_species_list <- 
  inverts_clean %>% 
  distinct(species_name) %>% 
  pull(species_name)

#Inverts addition
inverts_list <- 
  inverts_clean %>% 
  select(site_code,
         location,
         ecoregion,
         survey_year,
         phylum,
         species_name,
         taxon,
         latitude,
         longitude) %>% 
  distinct()


site_list_inverts <-
  inverts_clean %>% 
  select(site_code,
         location,
         ecoregion,
         latitude,
         longitude) %>% 
  distinct()


# Sum the total for each species within each unique survey_id
summed_data_inverts <- 
  inverts_clean %>%
  summarize(total_sum = sum(total), 
            .by = c(survey_id, species_name, survey_year, site_code))

# Calculate the average of the total per site x date combination
average_data_inverts <- summed_data_inverts %>%
  summarise(average_total = mean(total_sum), 
            .by = c(site_code, survey_year, survey_id, species_name))
```

```{r include=FALSE}
#Resolving the Goniocidaris impressa and Goniocidaris tubaria issue
filtered_data <- inverts_clean %>%
  filter(species_name %in% c("Goniocidaris impressa", "Goniocidaris tubaria"))

# write_csv(filtered_data, "filtered_inverts_data.csv")

#Once clean read back in and add to existing data
filtered_inverts <- read_csv("filtered_inverts_data.csv", show_col_types = FALSE)

# Filter the species you want to replace
species_to_replace <- c("Goniocidaris impressa", "Goniocidaris tubaria")

# Filter the rows in inverts_clean that match the species to be replaced
inverts_clean <- inverts_clean %>%
  filter(!species_name %in% species_to_replace)

# Add the new filtered data from filtered_inverts to inverts_clean
inverts_clean <- bind_rows(inverts_clean, filtered_inverts)

```

### Filtering years
```{r include=FALSE}
#filter NA's out of dataset M2
dat_no_na_inverts <-
  average_data_inverts |>
  drop_na(average_total)

#Filter out all data prior to 2008
#filter NA's out of dataset M1
inverts_clean <-
  average_data_inverts %>%
  filter(as.numeric(survey_year) >= 2008) %>% 
  mutate(site_yr = paste(site_code, survey_year, sep = "_")) %>% 
  summarise(total_per50m2 = mean(average_total),
            .by = c(site_code, survey_year, site_yr, species_name))
#view(inverts_clean)

inverts_clean |> 
  pull(survey_year) |> 
  range() #confirmed data range is 2008 - 2022
```

### Dealing with NAs
```{r include=FALSE}
# A list of all the site*year combinations
inverts_site_byyear <-
  inverts_clean |> 
  filter(!(is.na(total_per50m2)|total_per50m2 == 0)) |> # not recorded
  select(site_yr, site_code, survey_year) |> 
  distinct() 
  

# A list of all the site*year*species combinations
inverts_site_byspp <-
  inverts_clean |> 
  filter(!(is.na(total_per50m2)|total_per50m2 == 0)) |> # not recorded
  select(site_yr, site_code, species_name, survey_year) |> 
  distinct()

inverts_site_byspp_nested <- 
  inverts_site_byspp %>% 
  select(site_yr, site_code, species_name, survey_year) %>% 
  nest(.by = c(site_yr, site_code, survey_year))

inverts_data_addingzeros <-
  inverts_site_byyear %>%
  select(site_yr) %>%
  left_join(inverts_site_byspp_nested) %>%
  unnest(cols = c(data)) %>%
  left_join(inverts_clean %>%
              select(species_name,
                     site_yr,
                     site_code,
                     survey_year,
                     total_per50m2)) %>%
  mutate(total_per50m2 = replace_na(total_per50m2, 0)) %>%
  mutate(total_per50m2 = as.numeric(total_per50m2))


#| include = FALSE: INVERTS
inverts_data_addingzeros |> filter(is.na(total_per50m2)) |> nrow()

################ MinN attempt ##############
# Calculate the minimum density per species per site
min_density_inverts <- inverts_data_addingzeros %>%
  filter(total_per50m2 > 0) %>%
  group_by(site_code, species_name) %>%
  summarise(minN = min(total_per50m2)) %>%
  ungroup()

# Join the min_density_inverts table to the main invertebrate data table
inverts_data_with_minN <- inverts_data_addingzeros %>%
  left_join(min_density_inverts, by = c("site_code", "species_name"))

# Continue with the rest of your existing code
inverts_site_species_keep <- 
  inverts_data_with_minN %>% 
  filter(total_per50m2 > 0) %>% 
  add_count(site_code, species_name, name = "n_site_species") %>% 
  filter(n_site_species > 3) %>% 
  mutate(site_spp = paste(site_code, species_name, sep = "_")) %>% 
  pull(site_spp) %>% 
  unique()

inverts_data <- 
  inverts_data_with_minN %>% 
  left_join(site_list_inverts) %>% 
  mutate(n_sites_byspp = n(), .by = c(site_code, species_name)) %>% 
  mutate(n_obs_byspp = n(), .by = c(species_name)) %>% 
  filter(n_obs_byspp > n_sites_byspp) %>% 
  mutate(latitude  = round(latitude),
         longitude = round(longitude),
         log_count = log10(total_per50m2 + minN/2)) %>%  # Use minN for log transformation
   add_count(site_code, species_name, name = "n_site_species") %>% 
  filter(n_site_species > 3) %>% 
  filter(paste(site_code, species_name, sep = "_") %in% inverts_site_species_keep) %>%
  # species must be seen in more than one site
  filter(n_distinct(site_code) > 1, 
         .by = species_name)

################# END ####################
 
#Total number of species being considered after filtering: 1039
num_species_inverts <-
  inverts_data %>%
  distinct(species_name) %>%
  nrow()
print(num_species_inverts)


#Check to see if filtering has worked
table(inverts_data$site_code) %>% 
  sort() %>% 
  head()


#Check to see if filtering has worked
table(inverts_data$site_code) %>% 
  sort() %>% 
  head()

```

## Coral
Here, I will load in all coral data, from the RLS database - this data
is obtained through the photo-quadrats taken during the survey and then
these photos are scored to the highest taxonomic level by a coral
taxonomic expert, resulting in a coral percentage cover obtained through
analysis via a specialised program Squiddle+, a quincunx grid of 5
points was overlaid on each image and corals under each point were
recorded; thus, taxa under 100 points per transect are cataloged.

Observations that are only to species level have been used for this
analysis and the data has been filtered to ensure it is only from the
initiation of RLS, so from 2008 on ward.

### Cleaning counts
```{r include=FALSE}
sum(is.na(coral_raw$percent_cover))

#first let's check what groups are contained in the "coral raw" data frame
summary_table_coral <- table(coral_raw$RLE_category)
#view(summary_table_coral) 

#change date format:
coral_raw <- coral_raw %>%
  mutate(survey_year = as.numeric(substring(survey_date, nchar(survey_date) - 3, nchar(survey_date))))

#filter (and keep) inverts columns
coral_clean <- 
  coral_raw %>% 
  filter(str_detect(label, "[A-Z]{1}[a-z]+\\s{1}[a-z]+$")) %>% 
  filter(str_detect(country, "Australia")) %>% 
  filter(str_detect(RLE_category, "Coral")) %>%
  filter(!str_detect(label, "\\[|\\]")) %>% 
  filter(!str_detect(label, "\\bcorals\\b")) %>% 
  filter(!str_detect(label, "\\bcoral\\b")) %>% 
  filter(!str_detect(label, "\\bsp\\b")) %>% 
  as_tibble() %>% 
  rename(species_name = label) %>% 
  mutate(site_yr = paste(site_code, survey_year, sep = "_")) %>% 
  summarise(percent_cover = mean(percent_cover), 
            .by = c(site_code, 
                    site_yr,
                    survey_year, 
                    species_name))


coral_list <- 
  coral_raw %>% 
  select(survey_id,
         site_code,
         location,
         area,
         species_name = label,
         survey_year,
         depth,
         percent_cover,
         latitude,
         longitude) %>% 
  distinct()

coral_site_list <- 
  coral_raw %>% 
  select(site_code,
         species_name = label,
         survey_year,
         latitude,
         longitude) %>% 
  distinct()


```

### Dealing with NAs
```{r include=FALSE}

# A list of all the site*year combinations
site_byyear_coral <-
  coral_clean |> 
  filter(!(is.na(percent_cover)|percent_cover == 0)) |> # not recorded
  select(site_code, survey_year) |> 
  distinct() |> 
  mutate(site_code_yr = paste(site_code, survey_year, sep = "_"))

# A list of all the site*year*species combinations
site_byspp_coral <-
  coral_clean |> 
  filter(!(is.na(percent_cover)|percent_cover == 0)) |> # not recorded
  select(site_code, species_name) |> 
  distinct() |> 
  mutate(site_code_spp = paste(site_code, species_name, sep = "_"))

site_byspp_nested_coral <- 
  site_byspp_coral %>% 
  select(site_code, species_name) %>% 
  group_by(site_code) %>% 
  nest()

data_addingzeros_coral <- 
  site_byyear_coral %>% 
  select(site_code, survey_year) %>% 
  left_join(site_byspp_nested_coral) %>% 
  unnest(cols = c(data)) %>% 
  left_join(coral_clean %>% 
              select(site_code, 
                     survey_year,
                     species_name, 
                     percent_cover)) %>% 
  mutate(percent_cover = replace_na(percent_cover, 0)) %>%
  mutate(sqrt_pcover = sqrt(percent_cover)) 

#| include = FALSE: CORAL
data_addingzeros_coral |> filter(is.na(sqrt_pcover)) |> nrow()

##FINAL CLEAN
coral_site_species_keep <- 
  data_addingzeros_coral %>% 
  filter(sqrt_pcover > 0) %>% 
  add_count(site_code, species_name, name = "n_site_species") %>% 
  filter(n_site_species > 3) %>% 
  mutate(site_spp = paste(site_code, species_name, sep = "_")) %>% 
  pull(site_spp) %>% 
  unique()

coral_data <- 
  data_addingzeros_coral |> 
  left_join(coral_site_list) %>%
  mutate(n_sites_byspp = n(), .by = c(site_code, species_name)) %>% 
  mutate(n_obs_byspp = n(), .by = c(species_name)) %>% 
  filter(n_obs_byspp > n_sites_byspp) %>% 
  mutate(latitude  = round(latitude),
         longitude = round(longitude)) |> 
  mutate(transect_id = paste(site_code, survey_year, sep = "_")) %>% 
   add_count(site_code, species_name, name = "n_site_species") %>% 
  filter(n_site_species > 3) %>% 
  filter(paste(site_code, species_name, sep = "_") %in% coral_site_species_keep) %>%
  # species must be see in more than one site
  filter(n_distinct(site_code) > 1, 
         .by = species_name) 

#Total number of species being considered after filtering: 349
num_species_coral <- 
  coral_data %>%
  distinct(species_name) %>%
  nrow()
print(num_species_coral)

#Check to see if filtering has worked
table(coral_data$site_code) %>% 
  sort() %>% 
  head()

#Check to see if filtering has worked
table(coral_data$site_code)%>% 
  sort() %>% 
  head()
```

#Export all cleaned data ready for modelling
```{r include=FALSE}
#Export all clean data files for modelling
#Algae
file_name <- "algae_data.csv"
write.csv(algae_data, file_name, row.names = FALSE)

#Fish
file_name <- "fish_data.csv"
write.csv(fish_data, file_name, row.names = FALSE)

#Inverts
file_name <- "inverts_data.csv"
write.csv(inverts_data, file_name, row.names = FALSE)

#Coral
file_name <- "coral_data.csv"
write.csv(coral_data, file_name, row.names = FALSE)
```

# Modelling and plots
The second half of this analysis runs a series of Linear Mixed Effects models to
understand population trends of reef species around continental Australia from
2008 - 2022, and then produce the plots as per those seen in the manuscript by
Johnson et al. (in review)

# Data import
Read in the cleanly produced data files that were created in the chunks above. 
```{r - read in all tidied csv files}
algae_data <- read_csv("algae_data.csv", show_col_types = FALSE)

fish_data <- read_csv("fish_data.csv", show_col_types = FALSE)

inverts_data <- read_csv("inverts_data.csv", show_col_types = FALSE)

coral_data <- read_csv("coral_data.csv", show_col_types = FALSE)
```

## Covariate data
Read in further data covariate data that will be required
```{r covariate-data-import}
#Species-level information
species_tbl <- 
  read_csv(file = "species_info.csv", 
           show_col_types = FALSE, 
           skip_empty_rows = TRUE) 

#Temperature time-series (post-2008) data for each site
temperature_raw <- 
  read_csv(file =  "temperature_timeseries.csv",
           show_col_types = FALSE, 
           skip_empty_rows = TRUE)

#Endemism dataframe
endemism <- 
  read_csv(file =  "endemism.csv",
           show_col_types = FALSE, 
           skip_empty_rows = TRUE)
```

# Linear mixed effects models
Below, I will perform a series of linear mixed-effects models on the
data above that has been cleaned. Each major group will be analysed
separately (algae, fish, inverts and coral) and a loop performed on the
model so that each individual species has their trends over time
analysed.

Filter parameters set above are the bare minimum that are required in
order to fit a linear line and therefore perform the linear
mixed-effects models on the data.

All models appear to run, but there are some warnings at the end of the
loop. Where issues arise in the modelling including the "isSingular"
error, indicating convergence when the model runs and within the data
for the species the model is being performed. The individual species
that are having this error are then inspected, and in some instances has
been randomly plotted to see (if there are any obvious signs) what may
be causing convergence. If it appears that it is limited data to
effectively perform the model, the model loop is re-run, with a flag to
remove any species that are having the "singular fit" error when the
loop is performed.

The table output is the list of species that has had their trends over
time analysed and the major result values needed to understand the
trends put into a table (slope, intercept, p-value, and significance of
the trend).

## Algae LMM
```{r}
result_algae <- tibble(
  species_name = character(),
  slope = numeric(),
  intercept = numeric(),
  p_value = numeric(),
  ci_low = numeric(),
  ci_high = numeric(),
  se = numeric(),
  sd_residuals = numeric(),
  aic = numeric(),
  bic = numeric(),
  error_flag = character()  # New column to track the error flag
) 


###add in check of minimum number of years and observations for individual species (add to supplementary material)
algae_data %>% 
  select(species_name, survey_year) %>% 
  distinct() %>% 
  mutate(range_yrs = max(survey_year)-min(survey_year), 
         .by = species_name) %>% 
  count(species_name, range_yrs) %>% view()

for (i in unique(algae_data$species_name)) {
  
  mod_data_algae <- 
    algae_data %>% 
    filter(species_name == i)

# Check the number of unique levels of site_code for each species_name
  unique_levels <- n_distinct(algae_data$site_code)

  if (unique_levels <= 1) {
    warning(paste("Species", i, "has only one level of site_code. Consider using a different grouping variable."))
    next  # Skip to the next iteration
  }    
    
  tryCatch({
    
    algae_model <- 
    lmerTest::lmer(sqrt_cover ~ survey_year + (1|site_code), 
                   data = mod_data_algae) 
  
  intercept <- lme4::fixef(algae_model)[1] %>% as.numeric()
  slope <- lme4::fixef(algae_model)[2] %>% as.numeric()
  
  # Check if the model has a singular fit
  if (isSingular(algae_model)) {
    error_flag <- "Singular Fit"  # Set the error flag
  } else {
    error_flag <- ""  # No error flag
    
    # Extracting p-value
    p_value <- summary(algae_model)$coefficients[2, "Pr(>|t|)"]
    
    ci <- confint(algae_model, "survey_year")
    ci_low <- ci[1]
    ci_high <- ci[2]
    
    se <- summary(algae_model)$coefficients[2, "Std. Error"]
    sd_residuals <- summary(algae_model)$sigma
    aic <- AIC(algae_model)
    bic <- BIC(algae_model)
  }
  
  output <- summary(object = algae_model)
  
  result_algae <- 
    result_algae %>% 
    add_row(species_name = i, 
            slope = slope, 
            intercept = intercept, 
            p_value = p_value, 
            ci_low = ci_low, 
            ci_high = ci_high, 
            se = se, 
            sd_residuals = sd_residuals,
            aic = aic,
            bic = bic,
            error_flag = error_flag) %>%
    mutate(sig = case_when(p_value <= 0.001 ~ "***",
                           p_value <= 0.01  ~ "**",
                           p_value <= 0.05  ~ "*",
                           TRUE ~ ""))   }, error = function(e) {
    cat("Error occurred for species:", i, "\n")
    cat("Error message:", conditionMessage(e), "\n")
  })

  
  # print(summary(algae_model))
  
}

# Liv's previous comment:
#Model runs and produces results for 246 of the algae species - multiple species are having the error "boundary (singular) fit: see help('isSingular')" indicating there is a convergence issue with that species. Upon inspection of a few of the species where this error occurs in the model, there are only a very limited number of positive observations (>3 as set in the minimum parameters) in the data suggesting this could be causing issues in the algorithm's ability to find the optimal estimates of the model parameters. 

```

## Fish LMM
```{r}
result_fish <- tibble(
  species_name = character(),
  slope = numeric(),
  intercept = numeric(),
  p_value = numeric(),
  ci_low = numeric(),
  ci_high = numeric(),
  se = numeric(),
  sd_residuals = numeric(),
  aic = numeric(),
  bic = numeric(),
  error_flag = character()  # New column to track the error flag
) 


###add in check of minimum number of years and observations for individual species (add to supplementary material)
fish_data %>% 
  select(species_name, survey_year) %>% 
  distinct() %>% 
  mutate(range_yrs = max(survey_year)-min(survey_year), 
         .by = species_name) %>% 
  count(species_name, range_yrs) %>% view()


for (i in unique(fish_data$species_name)) {
  
  mod_data_fish <- 
    fish_data %>% filter(species_name == i)
#   
# # Check the number of unique levels of site_code for each species_name
#   unique_levels <- n_distinct(mod_data_fish$site_code) 
# 
# 
#   if (unique_levels <= 1) {
#     warning(paste("Species", i, "has only one level of site_code. Consider using a different grouping variable."))
#     next  # Skip to the next iteration
#   }  
  
  tryCatch({fish_model <- 
    lmerTest::lmer(log_count ~ year + (1|site_code), data = mod_data_fish) 
  
  intercept <- lme4::fixef(fish_model)[1] %>% as.numeric()
  slope <- lme4::fixef(fish_model)[2] %>% as.numeric()
  # print(i)
  
  # Check if the model has a singular fit
  if (isSingular(fish_model)) {
    error_flag <- "Singular Fit"  # Set the error flag
  } else {
    error_flag <- ""  # No error flag
    # Extracting p-value
    p_value <- summary(fish_model)$coefficients[2, "Pr(>|t|)"]
    
    ci <- confint(fish_model, "year")
    ci_low <- ci[1]
    ci_high <- ci[2]
    
    se <- summary(fish_model)$coefficients[2, "Std. Error"]
    sd_residuals <- summary(fish_model)$sigma
    aic <- AIC(fish_model)
    bic <- BIC(fish_model)
  }
  
  output <- summary(object = fish_model)
  
  result_fish <- result_fish %>% 
    add_row(species_name = i, 
            slope = slope, 
            intercept = intercept, 
            p_value = p_value, 
            ci_low = ci_low, 
            ci_high = ci_high, 
            se = se, 
            sd_residuals = sd_residuals,
            aic = aic,
            bic = bic,
            error_flag = error_flag) %>%
    mutate(sig = case_when(p_value <= 0.001 ~ "***",
                           p_value <= 0.01  ~ "**",
                           p_value <= 0.05  ~ "*",
                           TRUE ~ ""))  }, error = function(e) {
    cat("Error occurred for species:", i, "\n")
    cat("Error message:", conditionMessage(e), "\n")
  })
  
  #print(summary(fish_model))
  
}
```

## Invertebrates LMM
```{r}
result_inverts <- tibble(
  species_name = character(),
  slope = numeric(),
  intercept = numeric(),
  p_value = numeric(),
  ci_low = numeric(),
  ci_high = numeric(),
  se = numeric(),
  sd_residuals = numeric(),
  aic = numeric(),
  bic = numeric(),
  error_flag = character()  # New column to track the error flag
) 

###add in check of minimum number of years and observations for individual species (add to supplementary material)
inverts_data %>% 
  select(species_name, survey_year) %>% 
  distinct() %>% 
  mutate(range_yrs = max(survey_year)-min(survey_year), 
         .by = species_name) %>% 
  count(species_name, range_yrs) %>% view()

for (i in unique(inverts_data$species_name)) {
  
  mod_data_inverts <- 
    inverts_data %>% 
    filter(species_name == i)
  
# Check the number of unique levels of site_code for each species_name
  unique_levels <- n_distinct(inverts_data$site_code)  
  
    if (unique_levels <= 1) {
    warning(paste("Species", i, "has only one level of site_code. Consider using a different grouping variable."))
    next  # Skip to the next iteration
  }
  
  # Fit the mixed-effects model
  tryCatch({inverts_model <- lmerTest::lmer(log_count ~ survey_year + (1|site_code), data = mod_data_inverts) 
  
  intercept <- lme4::fixef(inverts_model)[1] %>% as.numeric()
  slope <- lme4::fixef(inverts_model)[2] %>% as.numeric()
  # print(i)
  
  # Check if the model has a singular fit
  if (isSingular(inverts_model)) {
    error_flag <- "Singular Fit"  # Set the error flag
  } else {
    error_flag <- ""  # No error flag
    # Extracting p-value
    p_value <- summary(inverts_model)$coefficients[2, "Pr(>|t|)"]
    
    ci <- confint(inverts_model, "survey_year")
    ci_low <- ci[1]
    ci_high <- ci[2]
    
    se <- summary(inverts_model)$coefficients[2, "Std. Error"]
    sd_residuals <- summary(inverts_model)$sigma
    aic <- AIC(inverts_model)
    bic <- BIC(inverts_model)
  }
  
  output <- summary(object = inverts_model)
  
  result_inverts <- result_inverts %>% 
    add_row(species_name = i, slope = slope, 
            intercept = intercept, 
            p_value = p_value,
            ci_low = ci_low, 
            ci_high = ci_high, 
            se = se, 
            sd_residuals = sd_residuals,
            aic = aic,
            bic = bic,
            error_flag = error_flag) %>%
    mutate(sig = case_when(p_value <= 0.001 ~ "***",
                           p_value <= 0.01  ~ "**",
                           p_value <= 0.05  ~ "*",
                           TRUE ~ "")) }, error = function(e) {
    cat("Error occurred for species:", i, "\n")
    cat("Error message:", conditionMessage(e), "\n")
  })
  
  # print(summary(inverts_model))
  
}
```

## Coral LMM
```{r}
result_coral <- tibble(
  species_name = character(),
  slope = numeric(),
  intercept = numeric(),
  p_value = numeric(),
  ci_low = numeric(),
  ci_high = numeric(),
  se = numeric(),
  sd_residuals = numeric(),
  aic = numeric(),
  bic = numeric(),
  error_flag = character()  # New column to track the error flag
) 

###add in check of minimum number of years and observations for individual species (add to supplementary material)
coral_data %>% 
  select(species_name, survey_year) %>% 
  distinct() %>% 
  mutate(range_yrs = max(survey_year)-min(survey_year), 
         .by = species_name) %>% 
  count(species_name, range_yrs) %>% view()


for (i in unique(coral_data$species_name)) {
  
  mod_data_coral <- coral_data %>% filter(species_name == i)
  
  
  # Check the number of unique levels of site_code for each species_name
  unique_levels <- n_distinct(coral_data$site_code)
  
  if (unique_levels <= 1) {
    warning(paste("Species", i, "has only one level of site_code. Consider using a different grouping variable."))
    next  # Skip to the next iteration
  }
  
  # Fit the mixed-effects model
  tryCatch({coral_model <- lmerTest::lmer(sqrt_pcover ~ survey_year + (1|site_code), data = mod_data_coral) 
  
  intercept <- lme4::fixef(coral_model)[1] %>% as.numeric()
  slope <- lme4::fixef(coral_model)[2] %>% as.numeric()
  # print(i)
  
  # Check if the model has a singular fit
  if (isSingular(coral_model)) {
    error_flag <- "Singular Fit"  # Set the error flag
  } else {
    error_flag <- ""  # No error flag
    # Extracting p-value
    p_value <- summary(coral_model)$coefficients[2, "Pr(>|t|)"]
    
    ci <- confint(coral_model, "survey_year")
    ci_low <- ci[1]
    ci_high <- ci[2]
    
    se <- summary(coral_model)$coefficients[2, "Std. Error"]
    sd_residuals <- summary(coral_model)$sigma
    aic <- AIC(coral_model)
    bic <- BIC(coral_model)
  }
  
  output <- summary(object = coral_model)
  
  result_coral <- result_coral %>% 
    add_row(species_name = i, slope = slope, 
            intercept = intercept, 
            p_value = p_value,
            ci_low = ci_low, 
            ci_high = ci_high, 
            se = se, 
            sd_residuals = sd_residuals,
            aic = aic,
            bic = bic,
            error_flag = error_flag) %>%
    mutate(sig = case_when(p_value <= 0.001 ~ "***",
                           p_value <= 0.01  ~ "**",
                           p_value <= 0.05  ~ "*",
                           TRUE ~ ""))  
  }, error = function(e) {
    cat("Error occurred for species:", i, "\n")
    cat("Error message:", conditionMessage(e), "\n")
  })
  
  # print(summary(coral_model))
  
}

```

# Rate of change
The slope and p-value do not mean much on their own - thus it is
important that a value is determined for the rate of change for each of
the species.

Below, the exact number of years a species has been measured that is
included in the model is determined. The slope is then divided by this
time portion, to give the rate of change of an individual species over 1
year (in both proportion and in a percentage form). This result is then
taken further (in the next chunk of code) and multiplied by 10 years -
as a measure of Criteria A "Population Size Reduction" of the IUCN Red
List Threatened Species Category (options are either 3 generations or 10
years - many of these species gave an unknown generation length). This
will then help determine the rate of change over a known number of years
for that species, and in turn, help to assign their conservation status
based on the IUCN Red List categories and criteria.
```{r rate-change}
#Algae
result_algae <- result_algae %>% 
  mutate(y_2008 = (intercept+slope*(2008))^2, 
         y_2021 = (intercept+slope*(2021))^2) %>% 
  mutate(diff = (y_2021-y_2008)) %>% 
  mutate(pc = (diff/y_2008)*100) %>% 
  mutate(decade_change = (pc/13)*10)

#Coral
result_coral <- result_coral %>% 
  mutate(y_2008 = (intercept+slope*(2008))^2, 
         y_2021 = (intercept+slope*(2021))^2) %>% 
  mutate(diff = (y_2021-y_2008)) %>% 
  mutate(pc = (diff/y_2008)*100) %>% 
  mutate(decade_change = (pc/13)*10)

#Fish
result_fish <- result_fish %>% 
  mutate(y_2008 = 10^(intercept+slope*(2008)), 
         y_2021 = 10^(intercept+slope*(2021))) %>% 
  mutate(diff = (y_2021-y_2008)) %>% 
  mutate(pc = (diff/y_2008)*100) %>% 
  mutate(decade_change = (pc/13)*10)

#Invertebrates
result_inverts <- result_inverts %>% 
  mutate(y_2008 = 10^(intercept+slope*(2008)), 
         y_2021 = 10^(intercept+slope*(2021))) %>% 
  mutate(diff = (y_2021-y_2008)) %>% 
  mutate(pc = (diff/y_2008)*100) %>% 
  mutate(decade_change = (pc/13)*10)
```

#Plotting
Read in csv of LMM results, rate of change from above and the species current 
IUCN status.This spreadsheet has also filtered out all of the species that 
produced the 'isSingular' error in the modelling stage. 
```{r}
#Read in data
trending_species <- read_csv("LMM_output.csv", show_col_types = FALSE)

#Decade decline plots
trending_species$taxon <- factor(trending_species$taxon, levels = c("Macroalgae", "Invertebrate", "Vertebrate"))
trending_species$biogeog <- factor(trending_species$biogeog, levels = c("cool (temperate)", "warm (temperate)", "tropical"))

#Endemic species plot
trending_species %>% 
  filter(p_value < 0.05, 
         slope < 0, 
         endemism == "endemic") %>% 
  ggplot(aes(x = decade_change, y = reorder(species_name, -decade_change))) +
  geom_rect(ymin = -Inf, ymax = Inf, xmin = -0, xmax = -30, fill = "#cccc33") +   
  geom_rect(ymin = -Inf, ymax = Inf, xmin = -30, xmax = -50, fill = "yellow") +
  geom_rect(ymin = -Inf, ymax = Inf, xmin = -50, xmax = -80, fill = "orange") +
  geom_rect(ymin = -Inf, ymax = Inf, xmin = -80, xmax = -100, fill = "red") +
  geom_vline(xintercept = c(-30, -50, -80), lty = 2) +
  geom_errorbarh(aes(xmin = after_stat(x - stat(y)), xmax = after_stat(x + stat(y)), height = 0.2)) + 
  geom_point(aes(shape = biogeog), size = 3) + #try a bigger sized point
  #geom_point(size = 3) + #####
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
    facet_wrap(~taxon, ncol = 1, scales = "free_y") +
  labs(
    x = "Rate of decline over a decade",
    y = "Species Name",
    shape = "") +
  theme_minimal() +
  theme(
    legend.position = "right",  
    panel.grid.major.y = element_blank(),  
    axis.title.y = element_blank(),  
    axis.text.y = element_text(face = "italic"), 
    plot.title = element_text(hjust = 0.5),
    strip.text = element_text(size = 12, hjust = 0)
  )

#Non-endemic species plot
trending_species %>% 
  filter(p_value < 0.05, 
         slope < 0, 
         endemism == "non-endemic") %>% 
  ggplot(aes(x = decade_change, y = reorder(species_name, -decade_change))) +
  geom_rect(ymin = -Inf, ymax = Inf, xmin = -0, xmax = -30, fill = "#cccc33") +   
  geom_rect(ymin = -Inf, ymax = Inf, xmin = -30, xmax = -50, fill = "yellow") +
  geom_rect(ymin = -Inf, ymax = Inf, xmin = -50, xmax = -80, fill = "orange") +
  geom_rect(ymin = -Inf, ymax = Inf, xmin = -80, xmax = -100, fill = "red") +
  geom_vline(xintercept = c(-30, -50, -80), lty = 2) +
  geom_errorbarh(aes(xmin = after_stat(x - stat(y)), xmax = after_stat(x + stat(y)), height = 0.2)) + 
  geom_point(aes(shape = biogeog), size = 3) +
  geom_point(size = 3) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  facet_grid(taxon ~ ., scales = "free_y", space = "free") +
  labs(
    x = "Rate of decline over a decade",
    y = "Species Name",
    shape = "") +
  theme_minimal() +
  theme(
    legend.position = "right",  
    panel.grid.major.y = element_blank(),  
    axis.title.y = element_blank(),  
    axis.text.y = element_text(face = "italic"), 
    plot.title = element_text(hjust = 0.5),
    strip.text = element_text(size = 11, hjust = 0.5, vjust = 1)
  ) 
```

#IUCN Status versus trend plots
```{r}
#Specify order of facet panels in plots
desired_order <- c("Macroalgae", "Coral", "Invertebrate", "Vertebrate")

#ENDEMICS
all_species_endemic <- trending_species %>%
  filter(endemism == "endemic") %>%
  mutate(new = case_when(
    decade_change >= 0 ~ "Least Concern",
    decade_change >= -29.99 & decade_change < 0 ~ "Near Threatened",
    decade_change >= -49.99 & decade_change < -29 ~ "Vulnerable",
    decade_change >= -79.99 & decade_change < -50 ~ "Endangered",
    decade_change >= -100 & decade_change < -80 ~ "Critically Endangered"
  )) 

all_species_endemic  %>%
  count(taxon, IUCN, new, species_name) %>%
  mutate(new = factor(new, levels = c("Endangered", "Vulnerable", "Near Threatened", "Least Concern", "Lower Risk/conservation dependent"))) %>%
  mutate(taxon = factor(taxon, levels = desired_order)) %>%
  ggplot(aes(x = IUCN, y = n, fill = new)) +
  geom_col() +
  facet_wrap(~taxon, ncol = 1,scales = "free_y") + 
  labs(x = "IUCN Red List Conservation Status",
       y = "Species Count",
       fill = "Population trend") +
  scale_fill_manual(
        values = c("Critically Endangered" = "red", "Endangered" = "orange", "Vulnerable" = "yellow", "Near Threatened" = "#cccc33", "Least Concern" = "green3"),
    breaks = c("Critically Endangered", "Endangered", "Vulnerable", "Near Threatened", "Least Concern")) +
  scale_x_discrete(limits = c("Not Evaluated", "Data Deficient", "Near Threatened", "Least Concern", "Vulnerable", "Endangered")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    legend.position = "right",
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(hjust = 0.5),
    strip.text = element_text(size = 11, hjust = 0),
    axis.title.y = element_text(margin = margin(r = 20)),
    strip.text.x = element_text(margin = margin(b = 10)),
    strip.text.y = element_text(margin = margin(r = 10)),
    axis.title.x = element_text(margin = margin(r = 40, t = 20))
  )

#NON-ENDEMICS
#Specify order of facet panels in plots
desired_order <- c("Macroalgae", "Coral", "Invertebrate", "Vertebrate")

all_species_non_endemic <- trending_species %>%
  filter(endemism == "non-endemic") %>%
  mutate(new = case_when(
    decade_change >= 0 ~ "Least Concern",
    decade_change >= -29.99 & decade_change < 0 ~ "Near Threatened",
    decade_change >= -49.99 & decade_change < -29 ~ "Vulnerable",
    decade_change >= -79.99 & decade_change < -50 ~ "Endangered",
    decade_change >= -100 & decade_change < -80 ~ "Critically Endangered"
  )) 

all_species_non_endemic %>%
  count(taxon, IUCN, new, species_name) %>%
  mutate(new = factor(new, levels = c("Endangered", "Vulnerable", "Near Threatened", "Least Concern"))) %>%
  mutate(taxon = factor(taxon, levels = desired_order)) %>%
  ggplot(aes(x = IUCN, y = n, fill = new)) +
  geom_col() +
  facet_wrap(~taxon, ncol = 1,scales = "free_y") + 
  labs(x = "IUCN Red List Conservation Status",
       y = "Species Count",
       fill = "Population trend") +
  scale_fill_manual(
    values = c("Critically Endangered" = "red", "Endangered" = "orange", "Vulnerable" = "yellow", "Near Threatened" = "#cccc33", "Least Concern" = "green3"),
    breaks = c("Critically Endangered", "Endangered", "Vulnerable", "Near Threatened", "Least Concern")) +
  scale_x_discrete(limits = c("Not Evaluated", "Lower Risk/conservation dependent", "Data Deficient", "Least Concern", "Near Threatened", "Vulnerable", "Endangered")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    legend.position = "right",
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(hjust = 0.5),
    strip.text = element_text(size = 11, hjust = 0),
    axis.title.y = element_text(margin = margin(r = 20)),
    strip.text.x = element_text(margin = margin(b = 10)),
    strip.text.y = element_text(margin = margin(r = 10)),
    axis.title.x = element_text(margin = margin(r = 40, t = 20))
  )
```

#Produce map of sites where all data is available from around Australia
#MAP
```{r packages for mapping}
library("ggplot2")
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
library("ggspatial")
library("ozmaps")
library("rnaturalearthhires")
```

```{r - themes}
theme_set(theme_bw())
world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)
```
#Determine latitude and longitude points
```{r - determine lats and longs - Clean}
#algae
algae_lats_longs_clean <- data.frame(Latitude = algae_data$latitude, Longitude = algae_data$longitude)

#fish
fish_lats_longs_clean <- data.frame(Latitude = fish_data$latitude, Longitude = fish_data$longitude)

#inverts
inverts_lats_longs_clean <- data.frame(Latitude = inverts_data$latitude, Longitude = inverts_data$longitude)

#coral
coral_lats_longs_clean <- data.frame(Latitude = coral_data$latitude, Longitude = coral_data$longitude)

# Combine latitude and longitude tables for algae, fish, inverts, and coral
all_lats_longs_clean <- bind_rows(algae_lats_longs_clean, fish_lats_longs_clean, inverts_lats_longs_clean, coral_lats_longs_clean)

```
#Produce map
```{r - lats and long code for map}
#RAW data map
coordinates <- all_lats_longs_clean

#how many sites in total are on this map?
unique_species_count <- length(unique(coordinates$Latitude))
unique_species_count


# Create a simple world map for context
world <- ne_countries(scale = "medium", returnclass = "sf")
oz_states <- ne_states(country = "Australia", returnclass = "sf")

# Plot the map with your data points
ggplot(data = world) +
  geom_sf(data = oz_states) +
  geom_point(data = coordinates, aes(x = Longitude, y = Latitude), color = "deepskyblue") +
  xlab("Longitude") + ylab("Latitude") +
  coord_sf(xlim = c(110.00, 160.00), ylim = c(-45.00, -8.00), expand = FALSE) +
  annotation_scale(location = "bl", width_hint = 0.3) +
  annotation_north_arrow(location = "bl", which_north = "true",
                         pad_x = unit(0.1, "in"), pad_y = unit(0.3, "in"),
                         style = north_arrow_fancy_orienteering) +
  theme_bw(base_size = 8)
```